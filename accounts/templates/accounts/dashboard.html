{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>

  <!-- Bootstrap CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Cream Grid Background -->
  <link rel="stylesheet" href="{% static 'css/grid-background.css' %}">

  <!-- Navbar Styles -->
  <link rel="stylesheet" href="{% static 'css/navbar.css' %}">

  <style>
    /* =========================================
       THEME & COLORS (Soft Modern Paynion Theme)
       ========================================= */
    /* Background is now standardized in grid-background.css */
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: #2d3436;
    }

    /* Navbar Override */
    .navbar {
      background-color: #ffffff !important;
      border-bottom: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      padding-top: 1rem;
      padding-bottom: 1rem;
    }

    .nav-link {
      color: #6c757d;
      font-weight: 500;
      padding: 0.5rem 1rem !important;
    }

    .nav-link.active,
    .nav-link:hover {
      color: #2d3436;
    }

    .nav-link.active {
      border-bottom: 2px solid #3498db;
    }

    /* Card Base Styles */
    .card {
      border: none;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      margin-bottom: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      background-color: #f0f9ff;
      border-color: #bae6fd;
    }

    .card-body {
      padding: 24px;
    }

    .profile-img {
      width: 38px;
      height: 38px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #fff;
      cursor: pointer;
    }

    /* =========================================
       TOP SECTION: SQUARE CARDS & ACTIONS
       ========================================= */
    .summary-cards-section {
      display: flex;
      gap: 20px;
      align-items: stretch;
      margin-bottom: 30px;
    }

    .cards-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      /* 3 Equal Cards */
      gap: 20px;
    }

    /* Square Card Design */
    .square-card {
      aspect-ratio: auto;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      /* Center content */
      align-items: flex-start;
      padding: 20px 24px;
      border-radius: 12px;
      border: none;
      background: #fff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: left;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      /* Match main card shadow */
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .square-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      background-color: #f0f9ff;
      border: 1px solid #bae6fd;
    }

    .square-card h6 {
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .square-card-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2d3436;
      margin: 0;
      line-height: 1.1;
    }

    .square-card-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      opacity: 0.15;
      /* Subtle background icon */
    }

    .square-card.groups .square-card-icon {
      color: #3498db;
    }

    .square-card.expenses .square-card-icon {
      color: #ff6b6b;
    }

    .square-card.balance .square-card-icon {
      color: #27ae60;
    }

    /* Action Buttons Card */
    .action-card-container {
      width: 280px;
      /* Fixed width for action buttons column */
      flex-shrink: 0;
    }

    .action-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 12px;
      padding: 10px;
    }

    .btn-action-sub {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .btn-action-sub i {
      font-size: 1.1rem;
    }

    .btn-action-sub:nth-child(1) {
      background: #3498db;
      color: white;
    }

    .btn-action-sub:nth-child(1):hover {
      background: #2980b9;
      color: white;
    }

    .btn-action-sub:nth-child(2) {
      background: #2ecc71;
      color: white;
    }

    .btn-action-sub:nth-child(2):hover {
      background: #27ae60;
      color: white;
    }

    .btn-action-sub:nth-child(3) {
      background: #f1c40f;
      color: #2d3436;
    }

    .btn-action-sub:nth-child(3):hover {
      background: #f39c12;
      color: #2d3436;
    }

    /* =========================================
       CHARTS SECTION
       ========================================= */
    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
    }

    .chart-header h5 {
      font-weight: 600;
      color: #2d3436;
      margin-bottom: 0;
    }

    .chart-header small {
      color: #6c757d;
      font-size: 0.85rem;
    }

    /* =========================================
       BOTTOM SECTION: GROUPS & EXPENSES
       ========================================= */
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2d3436;
      margin-bottom: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title a {
      font-size: 0.85rem;
      font-weight: 500;
      color: #3498db;
      text-decoration: none;
    }

    .section-title a:hover {
      text-decoration: underline;
    }

    /* Group Snapshots Item */
    .group-item {
      padding: 16px;
      border: 1px solid #f1f3f5;
      border-radius: 10px;
      margin-bottom: 12px;
      background: #fff;
      transition: border-color 0.2s;
    }

    .group-item:hover {
      border-color: #dee2e6;
    }

    .group-item:last-child {
      margin-bottom: 0;
    }

    .member-avatars img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #fff;
      object-fit: cover;
      margin-left: -10px;
    }

    .member-avatars img:first-child {
      margin-left: 0;
    }

    .progress {
      height: 6px;
      background-color: #f1f3f5;
      border-radius: 3px;
    }

    .progress-bar {
      border-radius: 3px;
    }

    /* Recent Expenses Row */
    .expense-row {
      display: flex;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f1f3f5;
    }

    .expense-row:last-child {
      border-bottom: none;
    }

    .expense-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background-color: #f8f9fa;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .expense-details h6 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #2d3436;
    }

    .expense-details small {
      font-size: 0.8rem;
      color: #adb5bd;
    }

    .expense-amount {
      margin-left: auto;
      font-weight: 700;
      font-size: 0.95rem;
      color: #e74c3c;
    }

    /* Responsive */
    @media (max-width: 991px) {
      .summary-cards-section {
        flex-direction: column;
      }

      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .action-card-container {
        width: 100%;
      }

      .action-card {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .btn-action-sub {
        flex: 1;
      }
    }

    @media (max-width: 576px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

  <!-- Include Modern Navbar -->
  {% include 'navbar.html' %}

  <div class="container mt-4">

    <h2 class="fw-bold mb-4 text-dark">Dashboard</h2>

    <!-- TOP SECTION: 3 CARDS + ACTION BUTTONS -->
    <div class="summary-cards-section">
      <!-- 3 Equal Cards Grid -->
      <div class="cards-grid">
        <!-- I Need to Pay Card -->
        <div class="card square-card groups shadow-sm">
          <div class="square-card-icon"><i class="fas fa-arrow-up"></i></div>
          <h6>I Need to Pay</h6>
          <p class="square-card-value">{{ total_pay|default:"â‚¹0.00" }}</p>
        </div>

        <!-- I Will Get Back Card -->
        <div class="card square-card expenses shadow-sm">
          <div class="square-card-icon"><i class="fas fa-arrow-down"></i></div>
          <h6>I Will Get Back</h6>
          <p class="square-card-value">{{ total_get|default:"â‚¹0.00" }}</p>
        </div>

        <!-- Total Spending Card -->
        <div class="card square-card balance shadow-sm">
          <div class="square-card-icon"><i class="fas fa-chart-pie"></i></div>
          <h6>Total Spending</h6>
          <p class="square-card-value">{{ total_spending|default:"â‚¹0.00" }}</p>
        </div>
      </div>

      <!-- Action Buttons (Right Side, Fixed Width) -->
      <div class="action-card-container">
        <div class="card shadow-sm">
          <div class="card-body action-card">
            <a href="{% url 'groups:view_all_group' %}?from=add_expense" class="btn-action-sub">
              <i class="fas fa-plus"></i> Add Expense
            </a>
            <a href="{% url 'groups:create_group' %}" class="btn-action-sub">
              <i class="fas fa-users"></i> Create Group
            </a>
            <a href="{% url 'accounts:report' %}" class="btn-action-sub">
              <i class="fas fa-chart-bar"></i> View Report
            </a>
          </div>
        </div>
      </div>
    </div>


    <!-- CHARTS SECTION -->
    <div class="row mt-2 g-3">
      <!-- LEFT CHART -->
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 chart-header">
              <div>
                <h5 class="mb-1">You Have to Pay vs You Will Get Back</h5>
                <small class="text-muted">Track your settlements</small>
              </div>
              <select id="chartPeriodFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="4days">Last 4 Days</option>
                <option value="4weeks" selected>Last 4 Weeks</option>
                <option value="4months">Last 4 Months</option>
              </select>
            </div>
            <div class="chart-container">
              <canvas id="oweVsOwedChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT CHART -->
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="chart-header mb-3">
              <h5 class="mb-1">Expense Breakdown</h5>
              <small class="text-muted">By category (Last 30 days)</small>
            </div>
            <div class="d-flex justify-content-center align-items-center" style="min-height: 240px;">
              <div style="position: relative; width: 220px; height: 220px;">
                <canvas id="categoryBreakdownChart"></canvas>
                <div
                  style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                  <div style="font-size: 1.4rem; font-weight: 700; color: #2d3436;" id="totalCategoryAmount">â‚¹0.00</div>
                  <div style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">TOTAL</div>
                </div>
              </div>
            </div>
            <div class="text-center mt-2" id="categoryLegend">
              <!-- Legend populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- BOTTOM SECTION: GROUPS & EXPENSES -->
    <div class="row mt-2 g-3">
      <!-- GROUP SNAPSHOTS -->
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="section-title">
              <span>Group Snapshots</span>
              <a href="{% url 'groups:view_all_group' %}">View All</a>
            </div>

            {% if groups %}
            <div class="group-list">
              {% for group in groups|slice:":3" %}
              <div class="group-item">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="fw-semibold mb-1 text-dark">{{ group.title }}</h6>
                    <small class="text-muted">Created by {{ group.created_by.first_name }}</small>
                  </div>
                  <span class="badge bg-success bg-opacity-10 text-success" style="font-size: 0.75rem;">Active</span>
                </div>

                <div class="d-flex align-items-center justify-content-between">
                  <div class="member-avatars d-flex align-items-center">
                    {% for member in group.members.all|slice:":3" %}
                    {% if member.profile_image %}
                    <img src="{{ member.profile_image.url }}" alt="{{ member.full_name }}"
                      title="{{ member.full_name }}">
                    {% else %}
                    <img src="{% static 'images/default-user.png' %}" alt="User" title="{{ member.full_name }}">
                    {% endif %}
                    {% endfor %}
                    {% if group.members.count > 3 %}
                    <div
                      class="rounded-circle bg-light d-flex align-items-center justify-content-center text-muted fw-bold"
                      style="width: 32px; height: 32px; margin-left: -10px; font-size: 0.75rem;">
                      +{{ group.members.count|add:"-3" }}
                    </div>
                    {% endif %}
                  </div>

                  <small class="text-muted fw-bold">â‚¹1,200 / â‚¹2,000</small>
                </div>

                <!-- Progress Bar -->
                <div class="progress mt-2">
                  <div class="progress-bar bg-info" role="progressbar" style="width: 60%;"></div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center py-4">No groups yet</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- RECENT EXPENSES -->
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="section-title">
              <span>Recent Expenses</span>
              <a href="{% url 'accounts:my_expenses' %}">View All</a>
            </div>

            {% if recent_expenses %}
            <div class="expense-list">
              {% for exp in recent_expenses|slice:":4" %}
              <div class="expense-row">
                <div class="expense-icon">
                  <i class="fas fa-receipt"></i>
                </div>
                <div class="expense-details">
                  <h6>{{ exp.description|truncatechars:20 }}</h6>
                  <small>{{ exp.created_at|date:"d M, h:i A" }} â€¢ {{ exp.paid_by.first_name }}</small>
                </div>
                <div class="expense-amount">-â‚¹{{ exp.amount }}</div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center py-4">No expenses yet</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>




  </div>

  <!-- Notification -->

  {% if notification %}
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;">
    <div id="notifyToast" class="toast text-bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          ðŸ”” {{ notification.message }}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
  {% endif %}




  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- <script>

const chartData = {
  labels: {{ chart.labels|safe }},
  paid: {{ chart.paid|safe }},
  need_to_pay: {{ chart.need_to_pay|safe }},
};

const ctx = document.getElementById("expenseChart").getContext("2d");

new Chart(ctx, {
  type: "bar",
  data: {
    labels: chartData.labels,
    datasets: [
      {
        label: "Paid by Me",
        data: chartData.paid,
      },
      {
        label: "I Need To Pay",
        data: chartData.need_to_pay,
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: "top" }
    }
  }
});
</script>




{% if notification %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const toastEl = document.getElementById("notifyToast");
  if (!toastEl) return;

  const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
  toast.show();

  // mark notification as read
  fetch("{% url 'accounts:mark_notification_read' notification.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    }
  });

});
</script> 
{% endif %} -->

  <script>
    const expenseChartData = {
      labels: {{ chart.labels| safe }},
    paid: { { chart.paid | safe } },
    need_to_pay: { { chart.need_to_pay | safe } },
};

    const expenseCtx = document
      .getElementById("expenseChart")
      .getContext("2d");

    new Chart(expenseCtx, {
      type: "bar",
      data: {
        labels: expenseChartData.labels,
        datasets: [
          {
            label: "Paid by Me",
            data: expenseChartData.paid,
          },
          {
            label: "I Need To Pay",
            data: expenseChartData.need_to_pay,
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>


  <script>
    let flowChartInstance = null;

    const flowChartData = {
      labels: {{ chart.weekly_labels| safe }},
    income: { { chart.weekly_income | safe } },
    outcome: { { chart.weekly_outcome | safe } }
};

    function initExpenseFlowChart(type = 'income') {
      const flowCtx = document.getElementById('expenseFlowChart').getContext('2d');

      const isIncome = type === 'income';
      const data = isIncome ? flowChartData.income : flowChartData.outcome;
      const colors = isIncome
        ? ['rgba(76, 175, 80, 0.7)', 'rgba(76, 175, 80, 0.7)', 'rgba(76, 175, 80, 0.7)', 'rgba(76, 175, 80, 0.7)']
        : ['rgba(244, 67, 54, 0.7)', 'rgba(244, 67, 54, 0.7)', 'rgba(244, 67, 54, 0.7)', 'rgba(244, 67, 54, 0.7)'];

      if (flowChartInstance) {
        flowChartInstance.destroy();
      }

      flowChartInstance = new Chart(flowCtx, {
        type: 'bar',
        data: {
          labels: flowChartData.labels,
          datasets: [
            {
              label: isIncome ? 'Income' : 'Outcome',
              data: data,
              backgroundColor: colors,
              borderColor: isIncome ? 'rgba(76, 175, 80, 1)' : 'rgba(244, 67, 54, 1)',
              borderWidth: 0,
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              display: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Initialize with income
    initExpenseFlowChart('income');

    // Add event listeners for toggle buttons
    document.querySelectorAll('input[name="flowType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        initExpenseFlowChart(e.target.value);
      });
    });

    // SPENDING CATEGORIES PIE CHART
    const categoryData = {{ category_json| safe }};

    if (categoryData.labels && categoryData.labels.length > 0) {
      const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');

      new Chart(categoriesCtx, {
        type: 'doughnut',
        data: {
          labels: categoryData.labels,
          datasets: [{
            data: categoryData.amounts,
            backgroundColor: categoryData.colors,
            borderColor: '#fff',
            borderWidth: 3,
            spacing: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '65%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 10,
              titleFont: { size: 12 },
              bodyFont: { size: 11 },
              callbacks: {
                label: function (context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return 'â‚¹' + value.toFixed(2) + ' (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }
  </script>


  {% if notification %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const toastEl = document.getElementById("notifyToast");
      if (!toastEl) return;

      const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
      toast.show();

      fetch("{% url 'accounts:mark_notification_read' notification.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      });

    });
  </script>
  {% endif %}

  <!-- NEW CHARTS JAVASCRIPT -->
  <script>
    // Parse chart data from backend
    const chartsData = {{ new_charts_json| safe }};

    // ============================================
    // CHART 1: YOU OWE VS YOU ARE OWED (BAR CHART)
    // ============================================

    const oweVsOwedCtx = document.getElementById('oweVsOwedChart').getContext('2d');
    let oweVsOwedChartInstance = null;

    function initOweVsOwedChart(data) {
      if (oweVsOwedChartInstance) {
        oweVsOwedChartInstance.destroy();
      }

      oweVsOwedChartInstance = new Chart(oweVsOwedCtx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'You Have to Pay',
              data: data.you_owe,
              backgroundColor: '#FF6B6B',
              borderColor: '#FF6B6B',
              borderWidth: 0,
              borderRadius: 4
            },
            {
              label: 'You Will Get Back',
              data: data.you_are_owed,
              backgroundColor: '#4ECDC4',
              borderColor: '#4ECDC4',
              borderWidth: 0,
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 10,
                font: { size: 11 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 10,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': â‚¹' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f1f3f5', drawBorder: false },
              ticks: { font: { size: 10 } }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
    }

    // Initialize chart with data
    initOweVsOwedChart(chartsData.owe_vs_owed);

    // ============================================
    // PERIOD FILTER HANDLER (AJAX)
    // ============================================

    // Set dropdown to match URL parameter on page load
    const urlParams = new URLSearchParams(window.location.search);
    const currentPeriod = urlParams.get('chart_period') || '4weeks';
    document.getElementById('chartPeriodFilter').value = currentPeriod;

    document.getElementById('chartPeriodFilter').addEventListener('change', function (e) {
      const selectedPeriod = e.target.value;
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('chart_period', selectedPeriod);

      // Reload page with new period parameter
      window.location.href = currentUrl.toString();
    });

    // ============================================
    // CHART 2: EXPENSE BREAKDOWN (DONUT CHART)
    // ============================================

    const categoryCtx = document.getElementById('categoryBreakdownChart').getContext('2d');

    // Update total amount display
    document.getElementById('totalCategoryAmount').textContent = 'â‚¹' + chartsData.category_breakdown.total.toFixed(2);

    // Create donut chart
    if (chartsData.category_breakdown.labels.length > 0) {
      new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: chartsData.category_breakdown.labels,
          datasets: [{
            data: chartsData.category_breakdown.amounts,
            backgroundColor: chartsData.category_breakdown.colors,
            borderColor: '#fff',
            borderWidth: 3,
            spacing: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              padding: 10,
              titleFont: { size: 12 },
              bodyFont: { size: 11 },
              callbacks: {
                label: function (context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return 'â‚¹' + value.toFixed(2) + ' (' + percentage + '%)';
                }
              }
            }
          }
        }
      });

      // Create category legend
      const legendContainer = document.getElementById('categoryLegend');
      let legendHTML = '<div class="d-flex flex-wrap justify-content-center gap-3">';

      chartsData.category_breakdown.labels.forEach((label, idx) => {
        const color = chartsData.category_breakdown.colors[idx];
        legendHTML += `
          <div class="d-flex align-items-center">
            <span style="width: 10px; height: 10px; border-radius: 50%; background-color: ${color}; display: inline-block; margin-right: 6px;"></span>
            <span style="font-size: 0.85rem; color: #6c757d;">${label}</span>
          </div>
        `;
      });

      legendHTML += '</div>';
      legendContainer.innerHTML = legendHTML;
    } else {
      // No data state
      document.getElementById('categoryLegend').innerHTML = '<p class="text-muted" style="font-size: 12px;">No expenses in the last 30 days</p>';
    }
  </script>







</body>

</html>
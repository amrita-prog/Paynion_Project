{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>

    <!-- Bootstrap CDN -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        .card-summary {
            border-left: 5px solid #0d6efd;
        }

        .profile-img {
            width: 38px;
            height: 38px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">

        <a class="navbar-brand" href="#">Paynion</a>

        <div class="d-flex align-items-center gap-3">

            <span class="text-white d-none d-md-inline">
                Hello, {{ request.user.full_name }}
            </span>

            <!-- PROFILE DROPDOWN -->
            <div class="dropdown">
                <a class="dropdown-toggle text-decoration-none"
                   href="#"
                   role="button"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">

                    <img
                      src="{% if request.user.profile_image %}
                           {{ request.user.profile_image.url }}
                           {% else %}
                           {% static 'images/default-user.png' %}
                           {% endif %}"
                      class="profile-img"
                      alt="Profile">
                </a>

                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item"
                           href="{% url 'accounts:profile' %}">
                            My Profile
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger"
                           href="{% url 'accounts:logout' %}">
                            Logout
                        </a>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</nav>

<div class="container mt-4">

    <h2 class="mb-4">Dashboard</h2>

    <!-- SUMMARY CARDS -->
    <div class="row">

        <div class="col-md-4 mb-3">
            <div class="card p-3 shadow-sm card-summary">
                <h4>Total Groups</h4>
                <p class="fs-4">{{ total_groups|default:"0" }}</p>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card p-3 shadow-sm card-summary">
                <h4>Total Expenses</h4>
                <p class="fs-4">{{ total_expenses|default:"0" }}</p>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card p-3 shadow-sm card-summary">
                <h4>Your Balance</h4>
                <p class="fs-4">â‚¹ {{ balance|default:"0" }}</p>
            </div>
        </div>

    </div>


    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'accounts:report' %}"
        class="btn btn-outline-primary">
        View Full Report
      </a>
    </div>


    


    <!-- EXPENSE CHART -->
    <div class="card shadow-sm mt-4">
    <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Expenses Overview</h5>

        <form method="get">
            <select name="weeks"
                    class="form-select form-select-sm w-auto"
                    onchange="this.form.submit()">
            {% for opt in week_options %}
                <option value="{{ opt.value }}"
                {% if request.GET.weeks == opt.value|stringformat:"s" %}selected{% endif %}>
                {{ opt.label }}
                </option>
            {% endfor %}
            </select>
        </form>
        </div>

        <canvas id="expenseChart" height="120"></canvas>

        <small class="text-muted d-block mt-2">
        Showing expenses based on selected duration
        </small>

    </div>
    </div>


    <!-- I WILL GET BACK CHART -->
    <div class="card shadow-sm mt-4">
    <div class="card-body">
        <h5 class="mb-3">I Will Get Back</h5>
        <canvas id="getBackChart" height="120"></canvas>
    </div>
    </div>

    <p>{{ chart.will_get_back }}</p>




    <!-- ACTION BUTTONS -->
    <div class="d-flex justify-content-between my-4">

        <div class="d-flex gap-2">
            <a href="{% url 'groups:create_group' %}" class="btn btn-success">
                + Create Group
            </a>

            <a href="{% url 'groups:view_all_group' %}"
               class="btn btn-outline-secondary">
                All Groups
            </a>
        </div>

        <a href="{% url 'groups:view_all_group' %}?from=add_expense"
           class="btn btn-primary">
            + Add Expense
        </a>

    </div>


    <!-- RECENT EXPENSES -->
    <div class="card shadow-sm p-3">
        <h4>Recent Expenses</h4>
        <hr>

        {% if recent_expenses %}
            {% for exp in recent_expenses %}
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <strong>{{ exp.description }}</strong>
                        <br>
                        <small class="text-muted">
                            Group: {{ exp.group.name }} |
                            â‚¹ {{ exp.amount }}
                        </small>
                    </div>

                    <small class="text-muted">
                        {{ exp.created_at|date:"d M Y" }}
                    </small>
                </div>
                <hr>
            {% endfor %}
        {% else %}
            <p class="text-muted">No recent expenses found.</p>
        {% endif %}
    </div>

</div>

</div>


<!-- Notification -->

{% if notification %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;">
  <div id="notifyToast"
       class="toast text-bg-primary border-0"
       role="alert">
    <div class="d-flex">
      <div class="toast-body">
        ðŸ”” {{ notification.message }}
      </div>
      <button type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endif %}




<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- <script>

const chartData = {
  labels: {{ chart.labels|safe }},
  paid: {{ chart.paid|safe }},
  need_to_pay: {{ chart.need_to_pay|safe }},
};

const ctx = document.getElementById("expenseChart").getContext("2d");

new Chart(ctx, {
  type: "bar",
  data: {
    labels: chartData.labels,
    datasets: [
      {
        label: "Paid by Me",
        data: chartData.paid,
      },
      {
        label: "I Need To Pay",
        data: chartData.need_to_pay,
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: "top" }
    }
  }
});
</script>




{% if notification %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const toastEl = document.getElementById("notifyToast");
  if (!toastEl) return;

  const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
  toast.show();

  // mark notification as read
  fetch("{% url 'accounts:mark_notification_read' notification.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    }
  });

});
</script> 
{% endif %} -->

<script>
const expenseChartData = {
  labels: {{ chart.labels|safe }},
  paid: {{ chart.paid|safe }},
  need_to_pay: {{ chart.need_to_pay|safe }},
};

const expenseCtx = document
  .getElementById("expenseChart")
  .getContext("2d");

new Chart(expenseCtx, {
  type: "bar",
  data: {
    labels: expenseChartData.labels,
    datasets: [
      {
        label: "Paid by Me",
        data: expenseChartData.paid,
      },
      {
        label: "I Need To Pay",
        data: expenseChartData.need_to_pay,
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: "top" }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});
</script>


<script>
const getBackCtx = document
  .getElementById("getBackChart")
  .getContext("2d");

new Chart(getBackCtx, {
  type: "line",
  data: {
    labels: {{ chart.labels|safe }},
    datasets: [
      {
        label: "I Will Get Back",
        data: {{ chart.will_get_back|safe }},
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 4,
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: {
        display: true
      }
    },
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});
</script>


{% if notification %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const toastEl = document.getElementById("notifyToast");
  if (!toastEl) return;

  const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
  toast.show();

  fetch("{% url 'accounts:mark_notification_read' notification.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    }
  });

});
</script>
{% endif %}






</body>
</html>

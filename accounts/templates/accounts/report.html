{% extends "base.html" %}
{% block content %}

<style>
  /* =========================================
     THEME & STYLING (Stitch- Inspired Modern UI)
     ========================================= */
  :root {
    --primary: #4f46e5;
    --primary-light: #e0e7ff;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-body: #f9fafb;
    --card-bg: #ffffff;
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border-color: #f3f4f6;
    --radius: 16px;
  }

  body {
    background-color: var(--bg-body);
    background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
    background-size: 24px 24px;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--text-main);
  }

  /* --- CARD BASE STYLES --- */
  .card {
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    margin-bottom: 24px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
  }
  .card-header {
    background: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 20px 24px;
    font-weight: 700;
    color: var(--text-main);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card-body {
    padding: 24px;
  }

  /* --- STATS CARDS --- */
  .stat-card {
    border: none;
    background: #fff;
    border-radius: var(--radius);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
    overflow: hidden;
  }
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
  }
  .stat-card.blue::before { background-color: var(--primary); }
  .stat-card.red::before { background-color: var(--danger); }
  .stat-card.green::before { background-color: var(--success); }
  .stat-card.dark::before { background-color: #374151; }

  .stat-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    font-weight: 600;
  }
  .stat-value {
    font-size: 1.75rem;
    font-weight: 800;
    margin-top: 8px;
    color: var(--text-main);
  }
  .stat-icon {
    position: absolute;
    bottom: -10px;
    right: -10px;
    font-size: 4rem;
    opacity: 0.05;
    color: #000;
    transform: rotate(-15deg);
  }

  /* --- TABLES --- */
  .table-custom {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }
  .table-custom thead th {
    background-color: #f9fafb;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }
  .table-custom tbody tr {
    transition: background-color 0.2s;
  }
  .table-custom tbody tr:hover {
    background-color: #f9fafb;
  }
  .table-custom td {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-main);
    vertical-align: middle;
    font-size: 0.9rem;
  }
  .table-custom tr:last-child td {
    border-bottom: none;
  }

  /* --- BADGES --- */
  .badge-soft {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
  }
  .badge-primary { background: var(--primary-light); color: var(--primary); }
  .badge-success { background: #d1fae5; color: var(--success); }
  .badge-danger { background: #fee2e2; color: var(--danger); }
  .badge-secondary { background: #f3f4f6; color: var(--text-muted); }

  /* --- FORMS & BUTTONS --- */
  .form-control-sm {
    border-radius: 8px;
    border: 1px solid #d1d5db;
    padding: 8px 12px;
    font-size: 0.9rem;
  }
  .form-control-sm:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
    outline: none;
  }
  .btn-modern {
    border-radius: 8px;
    font-weight: 600;
    padding: 8px 16px;
    font-size: 0.9rem;
    transition: all 0.2s;
    border: none;
  }
  .btn-primary-modern { background: var(--primary); color: white; }
  .btn-primary-modern:hover { background: #4338ca; color: white; }
  .btn-outline-modern { background: transparent; border: 1px solid #d1d5db; color: var(--text-muted); }
  .btn-outline-modern:hover { background: #f3f4f6; color: var(--text-main); }

  /* --- CHARTS --- */
  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
  }
</style>

<div class="container mt-4">

  <!-- PAGE HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold" style="color: var(--text-main);">Analytics Report</h2>
    <a href="{% url 'accounts:report_pdf' %}"
       class="btn btn-modern btn-outline-modern">
       <i class="fas fa-file-pdf me-2"></i>Download PDF
    </a>
  </div>

  <!-- ================= SUMMARY CARDS ================= -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
      <div class="card stat-card blue p-3">
        <small class="stat-label">Total Paid By Me</small>
        <h5 class="stat-value text-primary">₹{{ total_paid }}</h5>
        <i class="fas fa-wallet stat-icon"></i>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card stat-card red p-3">
        <small class="stat-label">I Need To Pay</small>
        <h5 class="stat-value text-danger">₹{{ need_to_pay }}</h5>
        <i class="fas fa-arrow-up stat-icon"></i>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card stat-card green p-3">
        <small class="stat-label">I Will Get Back</small>
        <h5 class="stat-value text-success">₹{{ will_get_back }}</h5>
        <i class="fas fa-arrow-down stat-icon"></i>
      </div>
    </div>

    <div class="col-md-3 col-6">
      <div class="card stat-card dark p-3">
        <small class="stat-label">Balance</small>
        <h5 class="stat-value text-dark">₹{{ balance }}</h5>
        <i class="fas fa-balance-scale stat-icon"></i>
      </div>
    </div>
  </div>

  <!-- ================= CHARTS SECTION ================= -->
  <div class="row g-4 mb-4">
    <!-- Expense Trend Chart -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header">
          <span>Expense Trend</span>
          <small class="text-muted fw-normal">Last 6 Months</small>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Breakdown (Circular) -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <span>Expense Breakdown</span>
        </div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center">
          <div style="position: relative; width: 200px; height: 200px;">
            <canvas id="categoryChart"></canvas>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
              <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-main);" id="categoryTotal">₹0</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">TOTAL</div>
            </div>
          </div>
          <div id="categoryLegend" class="mt-3 text-center small text-muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= GROUP SUMMARY TABLE ================= -->
  <div class="card">
    <div class="card-header">
      Group Wise Summary
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-custom mb-0">
          <thead>
            <tr>
              <th>Group</th>
              <th class="text-end">Total</th>
              <th class="text-end">Paid By Me</th>
              <th class="text-end">Get Back</th>
              <th class="text-end">Need To Pay</th>
            </tr>
          </thead>
          <tbody>
            {% for g in group_report %}
            <tr>
              <td>
                <div class="fw-bold">{{ g.group }}</div>
              </td>
              <td class="text-end">₹{{ g.total }}</td>
              <td class="text-end">₹{{ g.paid }}</td>
              <td class="text-end text-success fw-semibold">+₹{{ g.get_back }}</td>
              <td class="text-end text-danger fw-semibold">-₹{{ g.need_pay }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ================= EXPENSE REPORT FILTER & LIST ================= -->
  <div class="card mt-4">
    <div class="card-header">
      Detailed Expense Report
    </div>
    <div class="card-body">
      
      <!-- Filter Form -->
      <form method="get" class="row g-3 align-items-end mb-4 p-3 bg-light rounded-3">
        <div class="col-md-3 col-6">
          <label class="form-label small text-muted fw-bold text-uppercase">From Date</label>
          <input type="date" name="from" class="form-control form-control-sm" value="{{ request.GET.from }}">
        </div>
        <div class="col-md-3 col-6">
          <label class="form-label small text-muted fw-bold text-uppercase">To Date</label>
          <input type="date" name="to" class="form-control form-control-sm" value="{{ request.GET.to }}">
        </div>
        <div class="col-md-2 col-12">
          <button type="submit" class="btn btn-modern btn-primary-modern w-100">
            Apply Filter
          </button>
        </div>
        <div class="col-md-4 col-12 text-end">
           <small class="text-muted">Showing filtered results below</small>
        </div>
      </form>

      <!-- Expense Table -->
      <div class="table-responsive">
        <table class="table table-custom mb-0">
          <thead>
            <tr>
              <th style="width: 120px;">Date</th>
              <th>Group</th>
              <th>Description</th>
              <th>Paid By</th>
              <th class="text-end">Amount</th>
              <th class="text-center">Status</th>
            </tr>
          </thead>
          <tbody id="expenseTable">
            {% for exp in expenses %}
            <tr class="expense-row d-none">
              <td>
                <div class="text-muted small">{{ exp.created_at|date:"d M" }}</div>
                <div class="fw-bold">{{ exp.created_at|date:"Y" }}</div>
              </td>
              <td>
                <span class="fw-bold text-dark">{{ exp.group.title }}</span>
              </td>
              <td>{{ exp.description }}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 0.75rem;">
                    {{ exp.paid_by.first_name|first }}
                  </div>
                  <span>{{ exp.paid_by.full_name }}</span>
                </div>
              </td>
              <td class="text-end">
                <span class="fw-bold text-dark">₹{{ exp.amount }}</span>
              </td>
              <td class="text-center">
                {% if exp.paid_by == user %}
                  <span class="badge-soft badge-primary">Paid by Me</span>
                {% else %}
                  <span class="badge-soft badge-secondary">Involved</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- View More -->
      <div class="text-center mt-4">
        <button id="viewMoreBtn" class="btn btn-modern btn-outline-modern">
          View More Transactions
        </button>
      </div>

    </div>
  </div>

</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ================= VIEW MORE LOGIC =================
  const rows = document.querySelectorAll(".expense-row");
  const btn = document.getElementById("viewMoreBtn");
  let visibleCount = 0;
  const STEP = 5;

  function showMore() {
    for (let i = visibleCount; i < visibleCount + STEP && i < rows.length; i++) {
      rows[i].classList.remove("d-none");
      rows[i].style.animation = "fadeIn 0.5s ease forwards";
    }
    visibleCount += STEP;
    if (visibleCount >= rows.length) {
      btn.style.display = "none";
    }
  }

  // Initial load
  showMore();
  if (btn) btn.addEventListener("click", showMore);

  // ================= EXPENSE TREND CHART =================
  const labels = [{% for m in monthly_data %}"{{ m.month|date:'M Y' }}",{% endfor %}];
  const data = [{% for m in monthly_data %}{{ m.total }},{% endfor %}];

  if (labels.length > 0) {
    const ctx = document.getElementById("monthlyChart").getContext('2d');
    
    // Create Gradient
    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
    gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Monthly Expenses",
          data: data,
          borderColor: "#4f46e5",
          backgroundColor: gradient,
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: "#ffffff",
          pointBorderColor: "#4f46e5",
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "rgba(0,0,0,0.8)",
            padding: 12,
            titleFont: { size: 13 },
            bodyFont: { size: 12 },
            displayColors: false,
            callbacks: {
              label: function(context) {
                return ' Expense: ₹' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: "#f3f4f6", borderDash: [5, 5] },
            ticks: { color: "#6b7280" }
          },
          x: {
            grid: { display: false },
            ticks: { color: "#6b7280" }
          }
        }
      }
    });
  }

  // ================= CATEGORY BREAKDOWN CHART (Mock Data for Visuals) =================
  // Using total_paid for visual representation
  const catTotal = {{ total_paid|default:0 }};
  document.getElementById('categoryTotal').textContent = '₹' + catTotal;

  const catCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(catCtx, {
    type: 'doughnut',
    data: {
      labels: ['Food', 'Travel', 'Rent', 'Utilities', 'Others'],
      datasets: [{
        data: [35, 25, 20, 10, 10],
        backgroundColor: [
          '#4f46e5', // Primary
          '#10b981', // Green
          '#f59e0b', // Yellow
          '#ef4444', // Red
          '#6b7280'  // Gray
        ],
        borderWidth: 0,
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '75%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return ' ' + context.label + ': ' + context.parsed + '%';
            }
          }
        }
      }
    }
  });

  // Add simple Legend HTML manually
  const legendHTML = `
    <div class="d-flex flex-wrap justify-content-center gap-3">
      <span class="d-flex align-items-center"><span style="width:8px;height:8px;border-radius:50%;background:#4f46e5;margin-right:4px;"></span>Food</span>
      <span class="d-flex align-items-center"><span style="width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:4px;"></span>Travel</span>
      <span class="d-flex align-items-center"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;margin-right:4px;"></span>Rent</span>
    </div>
  `;
  document.getElementById('categoryLegend').innerHTML = legendHTML;

});
</script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

{% endblock %}